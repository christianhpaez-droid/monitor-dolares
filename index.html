<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor DÃ³lar ARS â€” Oficial â€¢ MEP â€¢ CCL â€¢ Blue â€¢ Cripto</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --panel2:#111827; --bdr:#1f2937;
      --text:#e5e7eb; --muted:#9ca3af; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --acc:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;background:linear-gradient(90deg,#0b1220,#0f172a);border-bottom:1px solid var(--bdr)}
    header h1{margin:0 0 4px 0;font-size:20px}
    header small{color:var(--muted)}
    .wrap{padding:16px;max-width:1200px;margin:0 auto;display:grid;gap:16px}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card,.panel{background:var(--panel);border:1px solid var(--bdr);border-radius:12px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .price{font-weight:800;font-size:26px}
    .muted{color:var(--muted);font-size:12px}
    .panel h2{margin:0 0 8px 0;font-size:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bdr);padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .pos{color:var(--ok)} .neg{color:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input,select,button{background:#0b1220;color:var(--text);border:1px solid var(--bdr);border-radius:8px;padding:8px}
    button{cursor:pointer;border-color:#334155}
    .hint{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid var(--bdr);border-radius:999px;padding:6px 10px}
    .err{color:var(--bad);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
<header>
  <h1>Monitor DÃ³lar ARS â€” Oficial â€¢ MEP â€¢ CCL â€¢ Blue â€¢ Cripto</h1>
  <small>Live configurable Â· Brechas y Arbitraje Â· HistÃ³rico Oficial con Bollinger (Canvas, sin CDN)</small>
</header>

<div class="wrap">
  <!-- Tarjetas -->
  <section class="grid cards" id="cards"></section>

  <!-- Brechas -->
  <section class="panel">
    <div class="toolbar">
      <h2>Brechas vs. Oficial</h2>
      <div class="pill">
        <label for="refreshSel" class="muted">ActualizaciÃ³n</label>
        <select id="refreshSel">
          <option value="5000">Cada 5s</option>
          <option value="10000" selected>Cada 10s</option>
          <option value="15000">Cada 15s</option>
          <option value="30000">Cada 30s</option>
          <option value="60000">Cada 60s</option>
        </select>
      </div>
      <button id="refreshNow">Actualizar ahora</button>
      <span id="lastUpdate" class="muted" style="margin-left:8px;"></span>
    </div>
    <div class="hint">Brecha = (Venta mercado âˆ’ Venta oficial) / Venta oficial Â· 100</div>
    <div style="overflow:auto;">
      <table id="brechasTbl">
        <thead><tr><th>Tipo</th><th>Compra</th><th>Venta</th><th>Brecha vs Oficial</th><th>ActualizaciÃ³n</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="errorMsg" class="err"></div>
  </section>

  <!-- Arbitraje -->
  <section class="panel">
    <h2>Arbitraje (SimulaciÃ³n rÃ¡pida)</h2>
    <div class="row" style="gap:14px;margin:6px 0 10px;">
      <div class="pill">
        <label class="muted" for="feePct">Costo total (fee + spread + impuestos) %</label>
        <input type="number" id="feePct" step="0.1" min="0" value="1.0" style="width:90px;">
      </div>
      <div class="pill">
        <label class="muted" for="ticket">Ticket ARS</label>
        <input type="number" id="ticket" step="100" min="1000" value="100000" style="width:120px;">
      </div>
      <button id="recalc">Recalcular</button>
    </div>
    <div class="hint">Regla: <b>comprÃ¡s</b> al precio <b>venta</b> del origen y <b>vendÃ©s</b> al precio <b>compra</b> del destino. Spread neto = Spread bruto âˆ’ costo total (%).</div>
    <div style="overflow:auto;">
      <table id="arbTbl">
        <thead><tr>
          <th>Origen</th><th>Destino</th>
          <th>Compra a</th><th>Vende en</th>
          <th>Spread bruto %</th><th>Costo %</th><th>Spread neto %</th><th>$/ARS por ticket</th><th>SeÃ±al</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- HistÃ³rico (Oficial) + Bollinger -->
<section class="panel" id="panelHist">
  <div class="toolbar">
    <h2>HistÃ³rico Oficial + Bollinger</h2>
    <!-- controles de SMA y botÃ³n Actualizar -->
  </div>

  <!-- AQUÃ pegas el bloque -->
  <div class="row" style="gap:10px;margin:6px 0 8px;">
    <!-- inputs de Bandas del Gobierno -->
  </div>

  <canvas id="histCanvas" height="340" style="width:100%;"></canvas>
  <div id="histErr" class="err"></div>
  <div class="hint">HistÃ³rico (Oficial) desde Bluelytics...</div>
</section>
    <canvas id="histCanvas" height="340" style="width:100%;"></canvas>
    <div id="histErr" class="err"></div>
    <div class="hint">HistÃ³rico (Oficial) desde Bluelytics con fallback; Bandas de Bollinger = SMA Â± kÂ·Ïƒ.</div>
  </section>
</div>
    <div class="row" style="gap:10px;margin:6px 0 8px;">
      <strong style="font-size:13px;">Bandas del Gobierno (Oficial):</strong>
      <label class="muted" for="govBaseDate">Base</label>
      <input id="govBaseDate" type="date" style="width:150px;">
      <label class="muted" for="govFloor">Piso</label>
      <input id="govFloor" type="number" step="0.01" style="width:110px;">
      <label class="muted" for="govCeil">Techo</label>
      <input id="govCeil" type="number" step="0.01" style="width:110px;">
      <label class="muted" for="govDrift">Deriva Â±%/mes</label>
      <input id="govDrift" type="number" step="0.1" min="0" style="width:90px;" value="1">
      <label class="muted" for="govProj">ProyecciÃ³n (meses)</label>
      <input id="govProj" type="number" min="0" max="12" value="1" style="width:90px;">
      <label class="muted" for="govFill">Sombrear</label>
      <input id="govFill" type="checkbox" checked>
      <button id="applyGov">Aplicar</button>
    </div>
<script>
/* --------- Limpieza de textos sueltos tipo CDN --------- */
(function scrubRogueText(){
  const bads = [
    'https://cdn.jsdelivr.net', 
    'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js'
  ];
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
  const toClear=[]; let n;
  while(n = walker.nextNode()){
    const s = (n.nodeValue||'').trim();
    if (!s) continue;
    if (bads.some(b => s.includes(b))) toClear.push(n);
  }
  toClear.forEach(n => n.nodeValue = '');
})();

/* --------- Utils --------- */
const $ = s => document.querySelector(s);
const fmtMoney = n => n==null ? 'â€”' : n.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2});
const fmtPct   = x => (x>0?'+':'') + (x).toFixed(2) + '%';
const nowStr   = iso => iso ? new Date(iso).toLocaleString('es-AR') : 'â€”';

/* --------- Proveedores (Dolarito primario, DolarApi fallback) --------- */
// Fallback pÃºblico documentado: DolarApi (todas las â€œcasasâ€ en un JSON).
// Docs: https://dolarapi.com/docs/argentina/operations/get-dolares
const ENDPOINT_LIVE = 'https://dolarapi.com/v1/dolares';

/* Dolarito (primario) â€” requiere plan â€œAcceso APIâ€ (pago).
   Hasta que te habiliten, deja URL y clave vacÃ­as (se usa DolarApi).
   Planes/API: https://cafecito.app/dolarito/plans  */
const DOLARITO_ENABLED   = true;    // intenta Dolarito primero si hay URL
const DOLARITO_URL       = '';      // ej: 'https://api.dolarito.ar/v1/cotizaciones'
const DOLARITO_HEADER    = 'Authorization'; // o 'X-API-Key' segÃºn indiquen
const DOLARITO_API_KEY   = '';      // ej: 'Bearer TU_TOKEN'

// HistÃ³rico (Oficial) â€” fuente Bluelytics; usaremos proxy JSON crudo (AllOrigins)
// y fallback a ArgentinaDatos si hiciera falta.
const ENDPOINT_HIST = days => `https://api.bluelytics.com.ar/v2/evolution.json?days=${days}`;

/* --------- Estado --------- */
let timer = null;
let refreshMs = 10000; // default 10s
let liveMap = null;

/* --------- Scheduler alineado al reloj --------- */
function scheduleNextTick(){
  if (timer) { clearTimeout(timer); timer = null; }
  const now = Date.now();
  const msToNext = refreshMs - (now % refreshMs);
  timer = setTimeout(async () => {
    try { await fetchLive(); } finally { scheduleNextTick(); }
  }, msToNext);
}
function configureRefresh(ms){
  refreshMs = Math.max(3000, +ms || 10000);
  scheduleNextTick();
}
$('#refreshSel').addEventListener('change', (e)=> configureRefresh(e.target.value));
$('#refreshNow').addEventListener('click', ()=> fetchLive());

/* --------- UI â€œliveâ€: tarjetas, brechas, arbitraje --------- */
function paintLive(map){
  // tarjetas
  const tipos = [
    ['oficial','DÃ³lar Oficial'],
    ['bolsa','DÃ³lar MEP'],
    ['contadoconliqui','DÃ³lar CCL'],
    ['blue','DÃ³lar Blue'],
    ['cripto','DÃ³lar Cripto'],
  ];
  $('#cards').innerHTML = tipos.map(([key,label])=>{
    const it = map[key]; if(!it) return '';
    return `<article class="card">
      <h3>${label}</h3>
      <div class="price">${fmtMoney(it.venta)}</div>
      <div class="muted">Compra: ${fmtMoney(it.compra)} Â· Venta: ${fmtMoney(it.venta)}</div>
      <div class="muted">Act.: ${nowStr(it.fechaActualizacion)}</div>
    </article>`;
  }).join('');

  // brechas
  const ofv = map?.oficial?.venta || null;
  const rows = [['Oficial','oficial'],['MEP','bolsa'],['CCL','contadoconliqui'],['Blue','blue'],['Cripto','cripto']]
    .map(([lbl,key])=>{
      const it = map[key]; if(!it) return '';
      const bre = (ofv && it.venta) ? ((it.venta - ofv)/ofv*100) : null;
      const cls = bre==null ? '' : (bre>=0?'pos':'neg');
      return `<tr>
        <td>${lbl}</td>
        <td>${fmtMoney(it.compra)}</td>
        <td>${fmtMoney(it.venta)}</td>
        <td class="${cls}">${bre==null?'â€”':fmtPct(bre)}</td>
        <td>${nowStr(it.fechaActualizacion)}</td>
      </tr>`;
    }).join('');
  $('#brechasTbl tbody').innerHTML = rows;

  // arbitraje
  renderArb(map);

  // marca de tiempo
  $('#lastUpdate').textContent = 'Ãšlt. actualizaciÃ³n: ' + new Date().toLocaleTimeString('es-AR');

  // limpiamos error si lo hubiera
  $('#errorMsg').textContent = '';
}

/* Arbitraje â€” compro a venta del origen; vendo a compra del destino */
const ARB_PAIRS = [
  ['oficial','bolsa'], ['oficial','contadoconliqui'], ['oficial','blue'], ['oficial','cripto'],
  ['blue','bolsa'], ['blue','contadoconliqui'],
  ['cripto','bolsa'], ['cripto','contadoconliqui'],
  ['bolsa','contadoconliqui'], ['contadoconliqui','bolsa'],
];
const LABEL = {oficial:'Oficial', bolsa:'MEP', contadoconliqui:'CCL', blue:'Blue', cripto:'Cripto'};

function renderArb(m){
  const fee = parseFloat($('#feePct').value||'0')/100;
  const ticket = Math.max(1000, parseFloat($('#ticket').value||'100000'));
  const rows = ARB_PAIRS.map(([src,dst])=>{
    const a = m[src], b = m[dst]; if(!a||!b) return '';
    const buy = a.venta;    // pago
    const sell = b.compra;  // recibo
    if(!buy||!sell) return '';
    const gross = (sell - buy)/buy;
    const net   = gross - fee;
    const earn  = Math.max(0, net) * ticket;
    const cls   = net>=0 ? 'pos':'neg';
    return `<tr>
      <td>${LABEL[src]}</td><td>${LABEL[dst]}</td>
      <td>${fmtMoney(buy)}</td><td>${fmtMoney(sell)}</td>
      <td>${fmtPct(gross*100)}</td><td>${fmtPct(fee*100)}</td>
      <td class="${cls}">${fmtPct(net*100)}</td>
      <td>${fmtMoney(earn)}</td>
      <td>${net>0?'ðŸŸ¢':'ðŸ”´'}</td>
    </tr>`;
  }).join('');
  $('#arbTbl tbody').innerHTML = rows;
}
$('#recalc').addEventListener('click', ()=> liveMap && renderArb(liveMap));
<!-- Controles de Bandas del Gobierno (Oficial) -->
    <div class="row" style="gap:10px;margin:6px 0 8px;">
      <strong style="font-size:13px;">Bandas del Gobierno (Oficial):</strong>
      <label class="muted" for="govBaseDate">Base</label>
      <input id="govBaseDate" type="date" style="width:150px;">
      <label class="muted" for="govFloor">Piso</label>
      <input id="govFloor" type="number" step="0.01" style="width:110px;">
      <label class="muted" for="govCeil">Techo</label>
      <input id="govCeil" type="number" step="0.01" style="width:110px;">
      <label class="muted" for="govDrift">Deriva Â±%/mes</label>
      <input id="govDrift" type="number" step="0.1" min="0" style="width:90px;" value="1">
      <label class="muted" for="govProj">ProyecciÃ³n (meses)</label>
      <input id="govProj" type="number" min="0" max="12" value="1" style="width:90px;">
      <label class="muted" for="govFill">Sombrear</label>
      <input id="govFill" type="checkbox" checked>
      <button id="applyGov">Aplicar</button>
    </div>
 /*** ==== Bandas del Gobierno (estado + helpers) ==== ***/
const govBand = {
  baseDate: '2025-04-11',  // fecha base
  floor: 1000,             // piso base en esa fecha
  ceil: 1400,              // techo base en esa fecha
  driftPct: 1,             // Â±%/mes (piso baja drift, techo sube drift)
  projMonths: 1,           // meses de proyecciÃ³n
  fill: true               // sombreado entre lÃ­neas
};

function monthsBetween(baseISO, dateISO){
  const b=new Date(baseISO), d=new Date(dateISO);
  const y=d.getFullYear()-b.getFullYear(), m=d.getMonth()-b.getMonth();
  return y*12 + m + (d.getDate()-b.getDate())/30;
}
function addDays(iso, n){ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

function buildGovBands(dates, baseDate, floor, ceil, driftPct){
  const k = (driftPct||0)/100;
  const piso=[], techo=[];
  for(const dt of dates){
    const m=monthsBetween(baseDate, dt);
    piso.push( floor*Math.pow(1-k, m) );
    techo.push( ceil *Math.pow(1+k, m) );
  }
  return {piso, techo};
}
function drawHistBollinger(canvas, points, w=20, k=2){
  if(!canvas || !points?.length) return;

  // ---- Fechas: histÃ³rico + proyecciÃ³n (para bandas) ----
  const histDates = points.map(p=>p.date);
  const lastHist  = histDates[histDates.length-1];
  const projDays  = Math.max(0, Math.round((+govBand.projMonths||0)*30));
  const projDates = Array.from({length:projDays}, (_,i)=> addDays(lastHist, i+1));
  const dates     = histDates.concat(projDates);

  // Serie de precio (solo histÃ³rico)
  const vals  = points.map(p=>p.value);

  // Canvas setup
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const cssWidth  = canvas.clientWidth || canvas.getBoundingClientRect().width || 900;
  const cssHeight = canvas.clientHeight || 340;
  canvas.width  = Math.round(cssWidth  * dpr);
  canvas.height = Math.round(cssHeight * dpr);
  const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);

  // Estilos
  const bg = getComputedStyle(document.documentElement).getPropertyValue('--panel') || '#0b1220';
  const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--bdr') || '#1f2937';
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9ca3af';
  const priceColor = getComputedStyle(document.documentElement).getPropertyValue('--acc') || '#60a5fa';
  const bandColor  = '#facc15';

  // Ãrea de dibujo
  const PAD = {l:56, r:14, t:14, b:24};
  const W = cssWidth - PAD.l - PAD.r;
  const H = cssHeight - PAD.t - PAD.b;
  const N = dates.length, N_hist = histDates.length;

  // Dominio Y con bandas
  const {piso, techo} = buildGovBands(dates, govBand.baseDate, +govBand.floor, +govBand.ceil, +govBand.driftPct);
  const minV = Math.min(Math.min(...vals), Math.min(...piso), Math.min(...techo));
  const maxV = Math.max(Math.max(...vals), Math.max(...piso), Math.max(...techo));
  const yMin = Math.floor(minV*0.98), yMax = Math.ceil(maxV*1.02);

  // Escalas
  const x2px = i => PAD.l + (N<=1? 0 : i*(W/(N-1)));
  const y2px = v => PAD.t + (yMax - v) * (H/(yMax - yMin || 1));

  // Fondo + grilla
  ctx.fillStyle = bg; ctx.fillRect(0,0,cssWidth,cssHeight);
  ctx.strokeStyle = gridColor; ctx.lineWidth = 1; ctx.beginPath();
  for(let t=0;t<=5;t++){ const y=PAD.t + t*(H/5); ctx.moveTo(PAD.l,y); ctx.lineTo(PAD.l+W,y); }
  ctx.stroke();

  // Ticks Y
  ctx.fillStyle = textColor; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto';
  for(let t=0;t<=5;t++){
    const v = yMax - t*((yMax-yMin)/5); const y = PAD.t + t*(H/5);
    ctx.fillText(v.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}), 6, y+4);
  }
  // Ticks X (inicio/medio/fin histÃ³rico)
  const idxs=[0, Math.floor(N_hist/2), Math.max(0,N_hist-1)].filter(i=>i>=0);
  idxs.forEach(i=>{ const x=x2px(i), y=PAD.t+H; ctx.fillText(dates[i], x-36, y+18); ctx.beginPath(); ctx.moveTo(x,y-4); ctx.lineTo(x,y); ctx.stroke(); });

  // ----- Bandas: sombreado opcional -----
  if (govBand.fill){
    ctx.beginPath();
    let started=false;
    for(let i=0;i<N;i++){ const x=x2px(i), y=y2px(techo[i]); if(!started){ctx.moveTo(x,y);started=true;} else ctx.lineTo(x,y); }
    for(let i=N-1;i>=0;i--){ const x=x2px(i), y=y2px(piso[i]); ctx.lineTo(x,y); }
    ctx.closePath(); ctx.fillStyle='rgba(250,204,21,0.10)'; ctx.fill();
  }

  // ----- Bandas: lÃ­neas piso/techo (histÃ³rico = sÃ³lido; proyecciÃ³n = punteado) -----
  function drawBandLine(arr, dashed){
    ctx.beginPath(); ctx.lineWidth=1.6; ctx.strokeStyle=bandColor;
    ctx.setLineDash(dashed? [6,4] : []);
    let started=false;
    for(let i=0;i<N;i++){
      const y=y2px(arr[i]), x=x2px(i);
      if(Number.isFinite(y)){ started? ctx.lineTo(x,y) : (ctx.moveTo(x,y), started=true); }
    }
    ctx.stroke(); ctx.setLineDash([]);
  }
  // histÃ³rico
  drawBandLine(piso.slice(0,N_hist), false);
  drawBandLine(techo.slice(0,N_hist), false);
  // proyecciÃ³n
  if (N_hist<N){
    drawBandLine([ ...Array(N_hist).fill(null), ...piso.slice(N_hist) ], true);
    drawBandLine([ ...Array(N_hist).fill(null), ...techo.slice(N_hist) ], true);
  }

  // Separador vertical entre histÃ³rico y proyecciÃ³n
  if (N_hist < N){
    const Xsep = x2px(N_hist-1)+((N>1)? (W/(N-1)) : 0);
    ctx.save(); ctx.strokeStyle='rgba(148,163,184,0.6)'; ctx.setLineDash([4,4]); ctx.beginPath();
    ctx.moveTo(Xsep, PAD.t); ctx.lineTo(Xsep, PAD.t+H); ctx.stroke(); ctx.restore();
  }

  // ----- Precio: lÃ­nea (solo histÃ³rico) -----
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=priceColor;
  points.forEach((p,i)=>{ const x=x2px(i), y=y2px(p.value); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // ----- Bollinger (SMA Â± kÂ·Ïƒ, solo histÃ³rico) -----
  const ma = sma(vals, w), sd = stdev(vals, w, ma);
  const up = ma.map((m,i)=> (m!=null && sd[i]!=null) ? m + k*sd[i] : null);
  const lo = ma.map((m,i)=> (m!=null && sd[i]!=null) ? m - k*sd[i] : null);

  function lineArr(arr, color, dashed=false){
    ctx.beginPath(); ctx.lineWidth = dashed? 1.2 : 1.5;
    ctx.strokeStyle=color; ctx.setLineDash(dashed? [6,4] : []);
    let started=false;
    for(let i=0;i<N_hist;i++){
      const y=y2px(arr[i]), x=x2px(i);
      if(Number.isFinite(y)){ started? ctx.lineTo(x,y) : (ctx.moveTo(x,y), started=true); }
    }
    ctx.stroke(); ctx.setLineDash([]);
  }
  lineArr(ma, '#94a3b8', true);
  lineArr(up, 'rgba(148,163,184,0.9)', true);
  lineArr(lo, 'rgba(148,163,184,0.9)', true);
}
async function loadHist(){
  $('#histErr').textContent='';
  // tomar parÃ¡metros UI
  govBand.baseDate = $('#govBaseDate').value || govBand.baseDate;
  govBand.floor    = parseFloat($('#govFloor').value||govBand.floor);
  govBand.ceil     = parseFloat($('#govCeil').value||govBand.ceil);
  govBand.driftPct = parseFloat($('#govDrift').value||govBand.driftPct);
  govBand.projMonths = Math.max(0, Math.min(12, parseFloat($('#govProj').value||govBand.projMonths)));
  govBand.fill     = $('#govFill').checked;

  const canvas = $('#histCanvas');
  const days = Math.max(60, Math.min(540, +($('#histDays').value||180)));
  const w    = Math.max(5,  Math.min(200, +($('#bbWindow').value||20)));
  const k    = Math.max(0.5,Math.min(4,   +($('#bbK').value||2)));
  try{
    const arr = await fetchHistOficial(days);
    if(!arr?.length) throw new Error('Sin datos');
    drawHistBollinger(canvas, arr, w, k);
  }catch(e){
    console.error(e);
    $('#histErr').textContent = 'Error al cargar histÃ³rico (Oficial).';
  }
}
$('#btnHist').addEventListener('click', loadHist);
$('#applyGov').addEventListener('click', loadHist);

// Inicializa los inputs con valores por defecto (al cargar)
document.addEventListener('DOMContentLoaded', ()=>{
  $('#govBaseDate').value = govBand.baseDate;
  $('#govFloor').value    = govBand.floor;
  $('#govCeil').value     = govBand.ceil;
  $('#govDrift').value    = govBand.driftPct;
  $('#govProj').value     = govBand.projMonths;
  $('#govFill').checked   = govBand.fill;
});
</script>
``



