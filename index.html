<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor DÃ³lar ARS â€” Oficial â€¢ MEP â€¢ CCL â€¢ Blue â€¢ Cripto</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --panel2:#111827; --bdr:#1f2937;
      --text:#e5e7eb; --muted:#9ca3af; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --acc:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;background:linear-gradient(90deg,#0b1220,#0f172a);border-bottom:1px solid var(--bdr)}
    header h1{margin:0 0 4px 0;font-size:20px}
    header small{color:var(--muted)}
    .wrap{padding:16px;max-width:1200px;margin:0 auto;display:grid;gap:16px}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card,.panel{background:var(--panel);border:1px solid var(--bdr);border-radius:12px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .price{font-weight:800;font-size:26px}
    .muted{color:var(--muted);font-size:12px}
    .panel h2{margin:0 0 8px 0;font-size:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bdr);padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .pos{color:var(--ok)} .neg{color:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input,select,button{background:#0b1220;color:var(--text);border:1px solid var(--bdr);border-radius:8px;padding:8px}
    button{cursor:pointer;border-color:#334155}
    .hint{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid var(--bdr);border-radius:999px;padding:6px 10px}
    .err{color:var(--bad);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
<header>
  <h1>Monitor DÃ³lar ARS â€” Oficial â€¢ MEP â€¢ CCL â€¢ Blue â€¢ Cripto</h1>
  <small>Live cada 30s Â· Brechas y Arbitraje Â· Sin dependencias externas</small>
</header>

<div class="wrap">
  <!-- Tarjetas -->
  <section class="grid cards" id="cards"></section>

  <!-- Brechas -->
  <section class="panel">
    <div class="toolbar">
      <h2>Brechas vs. Oficial</h2>
      <div class="pill">
        <label for="autoRefresh" class="muted">Auto-refresh 30s</label>
        <input type="checkbox" id="autoRefresh" checked />
      </div>
    </div>
    <div class="hint">Brecha = (Precio âˆ’ Oficial) / Oficial Â· 100 (usando <b>venta</b> de cada mercado vs <b>venta</b> oficial)</div>
    <div style="overflow:auto;">
      <table id="brechasTbl">
        <thead><tr><th>Tipo</th><th>Compra</th><th>Venta</th><th>Brecha vs Oficial</th><th>ActualizaciÃ³n</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="errorMsg" class="err"></div>
  </section>

  <!-- Arbitraje -->
  <section class="panel">
    <h2>Arbitraje (SimulaciÃ³n rÃ¡pida)</h2>
    <div class="row" style="gap:14px;margin:6px 0 10px;">
      <div class="pill">
        <label class="muted" for="feePct">Costo total (fee + spread + impuestos) %</label>
        <input type="number" id="feePct" step="0.1" min="0" value="1.0" style="width:90px;">
      </div>
      <div class="pill">
        <label class="muted" for="ticket">Ticket ARS</label>
        <input type="number" id="ticket" step="100" min="1000" value="100000" style="width:120px;">
      </div>
      <button id="recalc">Recalcular</button>
    </div>
    <div class="hint">Regla: <b>comprÃ¡s</b> al precio <b>venta</b> del origen y <b>vendÃ©s</b> al precio <b>compra</b> del destino. Spread neto = Spread bruto âˆ’ costo total (%).</div>
    <div style="overflow:auto;">
      <table id="arbTbl">
        <thead><tr>
          <th>Origen</th><th>Destino</th>
          <th>Compra a</th><th>Vende en</th>
          <th>Spread bruto %</th><th>Costo %</th><th>Spread neto %</th><th>$/ARS por ticket</th><th>SeÃ±al</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* --------- 1) Limpieza de textos sueltos tipo CDN (si quedaron en el HTML) --------- */
(function scrubRogueText(){
  const bads = [
    'https://cdn.jsdelivr.net', 
    'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js'
  ];
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
  const toClear=[];
  let n; while(n = walker.nextNode()){
    const s = (n.nodeValue||'').trim();
    if (!s) continue;
    if (bads.some(b => s.includes(b))) toClear.push(n);
  }
  toClear.forEach(n => n.nodeValue = '');
})();

/* --------- 2) Utilidades --------- */
const $ = s => document.querySelector(s);
const fmtMoney = n => n==null ? 'â€”' : n.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2});
const fmtPct   = x => (x>0?'+':'') + (x).toFixed(2) + '%';
const nowStr   = iso => iso ? new Date(iso).toLocaleString('es-AR') : 'â€”';

/* --------- 3) Endpoints --------- */
const ENDPOINT_LIVE = 'https://dolarapi.com/v1/dolares';              // Oficial, Blue, Bolsa (MEP), CCL, Cripto
const ENDPOINT_HIST = days => `https://api.bluelytics.com.ar/v2/evolution.json?days=${days}`; // (por si lo usamos luego)

/* --------- 4) Estado --------- */
let liveMap = null;
let timer = null;

/* --------- 5) Carga de cotizaciones --------- */
async function fetchLive(){
  try{
    const r = await fetch(ENDPOINT_LIVE,{cache:'no-store'});
    const data = await r.json();
    const m = {};
    for (const it of data) m[it.casa] = it; // casas: oficial, blue, bolsa (MEP), contadoconliqui (CCL), cripto, mayorista, etc.
    liveMap = m;
    renderCards(m);
    renderBrechas(m);
    renderArb(m);
    $('#errorMsg').textContent = '';
  }catch(e){
    console.error(e);
    $('#errorMsg').textContent = 'Error al cargar cotizaciones.';
  }
}

function renderCards(m){
  const tipos = [
    ['oficial','DÃ³lar Oficial'],
    ['bolsa','DÃ³lar MEP'],
    ['contadoconliqui','DÃ³lar CCL'],
    ['blue','DÃ³lar Blue'],
    ['cripto','DÃ³lar Cripto'],
  ];
  $('#cards').innerHTML = tipos.map(([key,label])=>{
    const it = m[key];
    if(!it) return '';
    return `<article class="card">
      <h3>${label}</h3>
      <div class="price">${fmtMoney(it.venta)}</div>
      <div class="muted">Compra: ${fmtMoney(it.compra)} Â· Venta: ${fmtMoney(it.venta)}</div>
      <div class="muted">Act.: ${nowStr(it.fechaActualizacion)}</div>
    </article>`;
  }).join('');
}

function renderBrechas(m){
  const ofv = m?.oficial?.venta || null;
  const rows = [
    ['Oficial', 'oficial'],
    ['MEP', 'bolsa'],
    ['CCL', 'contadoconliqui'],
    ['Blue','blue'],
    ['Cripto','cripto'],
  ].map(([lbl,key])=>{
    const it = m[key];
    if(!it) return '';
    const bre = (ofv && it.venta) ? ((it.venta - ofv)/ofv*100) : null;
    const cls = bre==null ? '' : (bre>=0?'pos':'neg');
    return `<tr>
      <td>${lbl}</td>
      <td>${fmtMoney(it.compra)}</td>
      <td>${fmtMoney(it.venta)}</td>
      <td class="${cls}">${bre==null?'â€”':fmtPct(bre)}</td>
      <td>${nowStr(it.fechaActualizacion)}</td>
    </tr>`;
  }).join('');
  $('#brechasTbl tbody').innerHTML = rows;
}

/* --------- 6) Arbitraje --------- */
// Reglas: compro al precio de VENTA del origen; vendo al precio de COMPRA del destino.
const ARB_PAIRS = [
  ['oficial','bolsa'],             // Oficial -> MEP
  ['oficial','contadoconliqui'],   // Oficial -> CCL
  ['oficial','blue'],              // Oficial -> Blue
  ['oficial','cripto'],            // Oficial -> Cripto
  ['blue','bolsa'],                // Blue -> MEP
  ['blue','contadoconliqui'],      // Blue -> CCL
  ['cripto','bolsa'],              // Cripto -> MEP
  ['cripto','contadoconliqui'],    // Cripto -> CCL
  ['bolsa','contadoconliqui'],     // MEP -> CCL
  ['contadoconliqui','bolsa'],     // CCL -> MEP
];

const LABEL = {
  oficial:'Oficial', bolsa:'MEP', contadoconliqui:'CCL', blue:'Blue', cripto:'Cripto'
};

function renderArb(m){
  const fee = parseFloat($('#feePct').value||'0')/100;
  const ticket = Math.max(1000, parseFloat($('#ticket').value||'100000'));
  const rows = ARB_PAIRS.map(([src,dst])=>{
    const a = m[src], b = m[dst]; if(!a||!b) return '';
    const buy = a.venta;    // precio que pago
    const sell = b.compra;  // precio que recibo
    if(!buy||!sell) return '';
    const gross = (sell - buy)/buy;    // %
    const net   = gross - fee;         // %
    const earn  = Math.max(0, net) * ticket; // ARS estimados por ticket (sin slippage adicional)
    const cls   = net>=0 ? 'pos':'neg';
    return `<tr>
      <td>${LABEL[src]}</td><td>${LABEL[dst]}</td>
      <td>${fmtMoney(buy)}</td><td>${fmtMoney(sell)}</td>
      <td>${fmtPct(gross*100)}</td><td>${fmtPct(fee*100)}</td>
      <td class="${cls}">${fmtPct(net*100)}</td>
      <td>${fmtMoney(earn)}</td>
      <td>${net>0?'ðŸŸ¢':'ðŸ”´'}</td>
    </tr>`;
  }).join('');
  $('#arbTbl tbody').innerHTML = rows;
}

$('#recalc').addEventListener('click', ()=> liveMap && renderArb(liveMap));

/* --------- 7) Auto-refresh --------- */
function setAutoRefresh(){
  if (timer) { clearInterval(timer); timer=null; }
  if ($('#autoRefresh').checked){
    timer = setInterval(fetchLive, 30000); // 30s
  }
}
$('#autoRefresh').addEventListener('change', setAutoRefresh);

/* --------- 8) Init --------- */
(async function init(){
  await fetchLive();
  setAutoRefresh();
})();
</script>
</body>
</html>
