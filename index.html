<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor Dólar ARS — Oficial • MEP • CCL • Blue • Cripto</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --panel2:#111827; --bdr:#1f2937;
      --text:#e5e7eb; --muted:#9ca3af; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --acc:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;background:linear-gradient(90deg,#0b1220,#0f172a);border-bottom:1px solid var(--bdr)}
    header h1{margin:0 0 4px 0;font-size:20px}
    header small{color:var(--muted)}
    .wrap{padding:16px;max-width:1200px;margin:0 auto;display:grid;gap:16px}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card,.panel{background:var(--panel);border:1px solid var(--bdr);border-radius:12px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .price{font-weight:800;font-size:26px}
    .muted{color:var(--muted);font-size:12px}
    .panel h2{margin:0 0 8px 0;font-size:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bdr);padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .pos{color:var(--ok)} .neg{color:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input,select,button{background:#0b1220;color:var(--text);border:1px solid var(--bdr);border-radius:8px;padding:8px}
    button{cursor:pointer;border-color:#334155}
    .hint{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid var(--bdr);border-radius:999px;padding:6px 10px}
    .err{color:var(--bad);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
<header>
  <h1>Monitor Dólar ARS — Oficial • MEP • CCL • Blue • Cripto</h1>
  <small>Live cada 30s · Brechas y Arbitraje · Gráfico Oficial con Bollinger (Canvas, sin CDN)</small>
</header>

<div class="wrap">
  <!-- Tarjetas -->
  <section class="grid cards" id="cards"></section>

  <!-- Brechas -->
  <section class="panel">
    <div class="toolbar">
      <h2>Brechas vs. Oficial</h2>
      <div class="pill">
        <label for="autoRefresh" class="muted">Auto-refresh 30s</label>
        <input type="checkbox" id="autoRefresh" checked />
      </div>
    </div>
    <div class="hint">Brecha = (Precio − Oficial) / Oficial · 100 (usando <b>venta</b> de cada mercado vs <b>venta</b> oficial)</div>
    <div style="overflow:auto;">
      <table id="brechasTbl">
        <thead><tr><th>Tipo</th><th>Compra</th><th>Venta</th><th>Brecha vs Oficial</th><th>Actualización</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="errorMsg" class="err"></div>
  </section>

  <!-- Arbitraje -->
  <section class="panel">
    <h2>Arbitraje (Simulación rápida)</h2>
    <div class="row" style="gap:14px;margin:6px 0 10px;">
      <div class="pill">
        <label class="muted" for="feePct">Costo total (fee + spread + impuestos) %</label>
        <input type="number" id="feePct" step="0.1" min="0" value="1.0" style="width:90px;">
      </div>
      <div class="pill">
        <label class="muted" for="ticket">Ticket ARS</label>
        <input type="number" id="ticket" step="100" min="1000" value="100000" style="width:120px;">
      </div>
      <button id="recalc">Recalcular</button>
    </div>
    <div class="hint">Regla: <b>comprás</b> al precio <b>venta</b> del origen y <b>vendés</b> al precio <b>compra</b> del destino. Spread neto = Spread bruto − costo total (%).</div>
    <div style="overflow:auto;">
      <table id="arbTbl">
        <thead><tr>
          <th>Origen</th><th>Destino</th>
          <th>Compra a</th><th>Vende en</th>
          <th>Spread bruto %</th><th>Costo %</th><th>Spread neto %</th><th>$/ARS por ticket</th><th>Señal</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Histórico (Oficial) + Bollinger -->
  <section class="panel" id="panelHist">
    <div class="toolbar">
      <h2>Histórico Oficial + Bollinger</h2>
      <div class="pill">
        <label class="muted" for="histDays">Días</label>
        <input type="number" id="histDays" min="60" max="540" value="180" style="width:90px;">
      </div>
      <div class="pill">
        <label class="muted" for="bbWindow">SMA ventana</label>
        <input type="number" id="bbWindow" min="5" max="200" value="20" style="width:100px;">
      </div>
      <div class="pill">
        <label class="muted" for="bbK">k σ</label>
        <input type="number" id="bbK" step="0.1" min="0.5" max="4" value="2" style="width:70px;">
      </div>
      <button id="btnHist">Actualizar</button>
    </div>
    <canvas id="histCanvas" height="340" style="width:100%;"></canvas>
    <div id="histErr" class="err"></div>
    <div class="hint">Datos históricos (Oficial) desde Bluelytics. Bandas de Bollinger = SMA ± k·σ.</div>
  </section>
</div>

<script>
/* --------- Limpieza de textos sueltos tipo CDN --------- */
(function scrubRogueText(){
  const bads = [
    'https://cdn.jsdelivr.net', 
    'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js'
  ];
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
  const toClear=[];
  let n; while(n = walker.nextNode()){
    const s = (n.nodeValue||'').trim();
    if (!s) continue;
    if (bads.some(b => s.includes(b))) toClear.push(n);
  }
  toClear.forEach(n => n.nodeValue = '');
})();

/* --------- Utils --------- */
const $ = s => document.querySelector(s);
const fmtMoney = n => n==null ? '—' : n.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2});
const fmtPct   = x => (x>0?'+':'') + (x).toFixed(2) + '%';
const nowStr   = iso => iso ? new Date(iso).toLocaleString('es-AR') : '—';

/* --------- Endpoints --------- */
const ENDPOINT_LIVE = 'https://dolarapi.com/v1/dolares';              // Oficial, Blue, Bolsa (MEP), CCL, Cripto
const ENDPOINT_HIST = days => `https://api.bluelytics.com.ar/v2/evolution.json?days=${days}`; // (sólo Oficial)

/* --------- Estado --------- */
let liveMap = null;
let timer = null;

/* --------- Carga de cotizaciones --------- */
async function fetchLive(){
  try{
    const r = await fetch(ENDPOINT_LIVE,{cache:'no-store'});
    const data = await r.json();
    const m = {};
    for (const it of data) m[it.casa] = it; // casas: oficial, blue, bolsa (MEP), contadoconliqui (CCL), cripto, etc.
    liveMap = m;
    renderCards(m);
    renderBrechas(m);
    renderArb(m);
    $('#errorMsg').textContent = '';
  }catch(e){
    console.error(e);
    $('#errorMsg').textContent = 'Error al cargar cotizaciones.';
  }
}

function renderCards(m){
  const tipos = [
    ['oficial','Dólar Oficial'],
    ['bolsa','Dólar MEP'],
    ['contadoconliqui','Dólar CCL'],
    ['blue','Dólar Blue'],
    ['cripto','Dólar Cripto'],
  ];
  $('#cards').innerHTML = tipos.map(([key,label])=>{
    const it = m[key];
    if(!it) return '';
    return `<article class="card">
      <h3>${label}</h3>
      <div class="price">${fmtMoney(it.venta)}</div>
      <div class="muted">Compra: ${fmtMoney(it.compra)} · Venta: ${fmtMoney(it.venta)}</div>
      <div class="muted">Act.: ${nowStr(it.fechaActualizacion)}</div>
    </article>`;
  }).join('');
}

function renderBrechas(m){
  const ofv = m?.oficial?.venta || null;
  const rows = [
    ['Oficial', 'oficial'],
    ['MEP', 'bolsa'],
    ['CCL', 'contadoconliqui'],
    ['Blue','blue'],
    ['Cripto','cripto'],
  ].map(([lbl,key])=>{
    const it = m[key];
    if(!it) return '';
    const bre = (ofv && it.venta) ? ((it.venta - ofv)/ofv*100) : null;
    const cls = bre==null ? '' : (bre>=0?'pos':'neg');
    return `<tr>
      <td>${lbl}</td>
      <td>${fmtMoney(it.compra)}</td>
      <td>${fmtMoney(it.venta)}</td>
      <td class="${cls}">${bre==null?'—':fmtPct(bre)}</td>
      <td>${nowStr(it.fechaActualizacion)}</td>
    </tr>`;
  }).join('');
  $('#brechasTbl tbody').innerHTML = rows;
}

/* --------- Arbitraje --------- */
// Reglas: compro al precio de VENTA del origen; vendo al precio de COMPRA del destino.
const ARB_PAIRS = [
  ['oficial','bolsa'], ['oficial','contadoconliqui'], ['oficial','blue'], ['oficial','cripto'],
  ['blue','bolsa'], ['blue','contadoconliqui'],
  ['cripto','bolsa'], ['cripto','contadoconliqui'],
  ['bolsa','contadoconliqui'], ['contadoconliqui','bolsa'],
];
const LABEL = {oficial:'Oficial', bolsa:'MEP', contadoconliqui:'CCL', blue:'Blue', cripto:'Cripto'};

function renderArb(m){
  const fee = parseFloat($('#feePct').value||'0')/100;
  const ticket = Math.max(1000, parseFloat($('#ticket').value||'100000'));
  const rows = ARB_PAIRS.map(([src,dst])=>{
    const a = m[src], b = m[dst]; if(!a||!b) return '';
    const buy = a.venta;    // pago
    const sell = b.compra;  // recibo
    if(!buy||!sell) return '';
    const gross = (sell - buy)/buy;
    const net   = gross - fee;
    const earn  = Math.max(0, net) * ticket;
    const cls   = net>=0 ? 'pos':'neg';
    return `<tr>
      <td>${LABEL[src]}</td><td>${LABEL[dst]}</td>
      <td>${fmtMoney(buy)}</td><td>${fmtMoney(sell)}</td>
      <td>${fmtPct(gross*100)}</td><td>${fmtPct(fee*100)}</td>
      <td class="${cls}">${fmtPct(net*100)}</td>
      <td>${fmtMoney(earn)}</td>
      <td>${net>0?'🟢':'🔴'}</td>
    </tr>`;
  }).join('');
  $('#arbTbl tbody').innerHTML = rows;
}
$('#recalc').addEventListener('click', ()=> liveMap && renderArb(liveMap));

/* --------- Auto-refresh --------- */
function setAutoRefresh(){
  if (timer) { clearInterval(timer); timer=null; }
  if ($('#autoRefresh').checked){
    timer = setInterval(fetchLive, 30000); // 30s
  }
}
$('#autoRefresh').addEventListener('change', setAutoRefresh);

/* --------- Histórico + Bollinger (Canvas puro) --------- */
async function fetchHistOficial(days=180){
  const url = ENDPOINT_HIST(days);
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const all = await r.json();
  const arr = all.filter(d=>d.type==='Oficial')
                 .sort((a,b)=> new Date(a.day)-new Date(b.day))
                 .map(d=> ({ date:d.day, value:+d.value_sell }));
  return arr;
}
function sma(values, w){
  const out=new Array(values.length).fill(null);
  let sum=0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=w) sum -= values[i-w];
    if(i>=w-1) out[i] = sum/w;
  }
  return out;
}
function stdev(values, w, ma){
  const out=new Array(values.length).fill(null);
  for(let i=0;i<values.length;i++){
    if(i>=w-1){
      let s2=0;
      for(let j=i-w+1;j<=i;j++){
        const d = values[j]-ma[i];
        s2 += d*d;
      }
      out[i]=Math.sqrt(s2/w);
    }
  }
  return out;
}
function drawHistBollinger(canvas, points, w=20, k=2){
  if(!canvas || !points?.length) return;
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const cssWidth  = canvas.clientWidth || canvas.getBoundingClientRect().width || 900;
  const cssHeight = canvas.clientHeight || 340;
  canvas.width  = Math.round(cssWidth  * dpr);
  canvas.height = Math.round(cssHeight * dpr);

  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  const bg = getComputedStyle(document.documentElement).getPropertyValue('--panel') || '#0b1220';
  const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--bdr') || '#1f2937';
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9ca3af';
  const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--acc') || '#60a5fa';
  const PAD = {l:56, r:14, t:14, b:24};
  const W = cssWidth - PAD.l - PAD.r;
  const H = cssHeight - PAD.t - PAD.b;

  const vals = points.map(p=>p.value);
  const dates = points.map(p=>p.date);
  const minV = Math.min(...vals.filter(v=>isFinite(v)));
  const maxV = Math.max(...vals.filter(v=>isFinite(v)));
  const yMin = Math.floor(minV*0.98), yMax = Math.ceil(maxV*1.02);

  const x2px = i => PAD.l + i*(W/(points.length-1||1));
  const y2px = v => PAD.t + (yMax - v) * (H/(yMax - yMin || 1));

  // Fondo
  ctx.fillStyle = bg; ctx.fillRect(0,0,cssWidth,cssHeight);
  // Grid
  ctx.strokeStyle = gridColor; ctx.lineWidth = 1; ctx.beginPath();
  for(let t=0;t<=5;t++){ const y=PAD.t + t*(H/5); ctx.moveTo(PAD.l,y); ctx.lineTo(PAD.l+W,y); }
  ctx.stroke();
  // Ticks Y
  ctx.fillStyle = textColor; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto';
  for(let t=0;t<=5;t++){
    const v = yMax - t*( (yMax-yMin)/5 ); const y = PAD.t + t*(H/5);
    ctx.fillText(v.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}), 6, y+4);
  }
  // Ticks X (inicio/medio/fin)
  const idxs=[0,Math.floor(points.length/2),points.length-1].filter(i=>i>=0);
  idxs.forEach(i=>{ const x=x2px(i), y=PAD.t+H; ctx.fillText(dates[i], x-36, y+18); ctx.beginPath(); ctx.moveTo(x,y-4); ctx.lineTo(x,y); ctx.stroke(); });

  // Bollinger
  const ma = sma(vals, w);
  const sd = stdev(vals, w, ma);
  const upper = ma.map((m,i)=> (m!=null && sd[i]!=null) ? m + k*sd[i] : null);
  const lower = ma.map((m,i)=> (m!=null && sd[i]!=null) ? m - k*sd[i] : null);

  // Relleno entre bandas
  ctx.beginPath(); let started=false;
  for(let i=0;i<points.length;i++){ if(upper[i]==null) continue; const x=x2px(i), y=y2px(upper[i]); if(!started){ctx.moveTo(x,y);started=true;} else ctx.lineTo(x,y); }
  for(let i=points.length-1;i>=0;i--){ if(lower[i]==null) continue; const x=x2px(i), y=y2px(lower[i]); ctx.lineTo(x,y); }
  ctx.closePath(); ctx.fillStyle='rgba(96,165,250,0.10)'; ctx.fill();

  // Precio
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=lineColor;
  points.forEach((p,i)=>{ const x=x2px(i), y=y2px(p.value); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // SMA
  ctx.beginPath(); ctx.lineWidth=1.5; ctx.strokeStyle='#94a3b8'; ctx.setLineDash([6,4]);
  for(let i=0;i<points.length;i++){ if(ma[i]==null) continue; const x=x2px(i), y=y2px(ma[i]); (i && ma[i-1]!=null)?ctx.lineTo(x,y):ctx.moveTo(x,y); }
  ctx.stroke(); ctx.setLineDash([]);

  // Upper
  ctx.beginPath(); ctx.lineWidth=1; ctx.strokeStyle='rgba(148,163,184,0.9)'; ctx.setLineDash([6,4]);
  for(let i=0;i<points.length;i++){ if(upper[i]==null) continue; const x=x2px(i), y=y2px(upper[i]); (i && upper[i-1]!=null)?ctx.lineTo(x,y):ctx.moveTo(x,y); }
  ctx.stroke();

  // Lower
  ctx.beginPath(); ctx.lineWidth=1; ctx.strokeStyle='rgba(148,163,184,0.9)';
  for(let i=0;i<points.length;i++){ if(lower[i]==null) continue; const x=x2px(i), y=y2px(lower[i]); (i && lower[i-1]!=null)?ctx.lineTo(x,y):ctx.moveTo(x,y); }
  ctx.stroke(); ctx.setLineDash([]);
}
async function loadHist(){
  $('#histErr').textContent='';
  const canvas = $('#histCanvas');
  const days = Math.max(60, Math.min(540, +($('#histDays').value||180)));
  const w    = Math.max(5,  Math.min(200, +($('#bbWindow').value||20)));
  const k    = Math.max(0.5,Math.min(4,   +($('#bbK').value||2)));
  try{
    const arr = await fetchHistOficial(days);
    if(!arr?.length) throw new Error('Sin datos');
    drawHistBollinger(canvas, arr, w, k);
  }catch(e){
    console.error(e);
    $('#histErr').textContent = 'Error al cargar histórico (Oficial).';
  }
}
$('#btnHist').addEventListener('click', loadHist);

/* --------- Init --------- */
(async function init(){
  await fetchLive();
  setAutoRefresh();
  // Carga inicial del histórico
  setTimeout(loadHist, 800);
})();
</script>
</body>
</html>
``
